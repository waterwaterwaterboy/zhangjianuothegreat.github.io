<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="description" content="Unlock your cosmic destiny with the Lucky Direction Compass, blending ancient wisdom, your birth chart, and real-time star alignment to guide you to peace and success.">
    <meta name="keywords" content="lucky direction, cosmic compass, astrology, mindfulness, sound bath">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline'; 
        connect-src https://lucky-compass-backend.fly.dev; 
        media-src 'self' blob: /static/sound_bath/*; 
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src https://fonts.gstatic.com;
    ">
    <title>Unlock Your Cosmic Compass</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="bg-gray-100 font-roboto text-gray-800">
    <header class="text-center py-8 bg-gradient-to-r from-blue-800 to-teal-600 text-white">
        <h1 class="text-4xl font-bold">Unlock Your Cosmic Compass</h1>
        <p class="mt-2 text-lg">Discover your unique path to luck and serenity, guided by the stars and ancient wisdom.</p>
    </header>

    <nav class="bg-blue-900 p-4 shadow-md">
        <div class="container mx-auto flex justify-center space-x-6">
            <a href="https://www.yourluckycompass.com/" class="text-white hover:underline">Home</a>
            <a href="https://www.yourluckycompass.com/bazi" class="text-white hover:underline">Cosmic Blueprint</a>
            <a href="https://www.yourluckycompass.com/lucky-city" class="text-white hover:underline">Lucky City Match</a>
            <a href="#" class="text-white hover:underline font-bold">Cosmic Compass</a>
            <a href="https://www.yourluckycompass.com/sound-bath" class="text-white hover:underline">Sound Bath</a>
        </div>
    </nav>

    <section class="container mx-auto p-6 max-w-4xl">
        <div class="card bg-white p-6 rounded-lg shadow-md mb-6">
            <p class="mb-4 text-center">Tap into the universe’s energy! Enter your birth date and timezone to reveal your personal cosmic degree—a star-guided key to inner peace and success. Sync with a soothing Sound Bath and rotate your phone to align with the cosmos!</p>
            <div class="space-y-4 max-w-md mx-auto">
                <input type="number" id="year" placeholder="Year (1900-2025)" min="1900" max="2025" required class="w-full p-2 border rounded-md">
                <p class="text-sm text-gray-500">* Year must be 1900-2025</p>
                <input type="number" id="month" placeholder="Month (1-12)" min="1" max="12" required class="w-full p-2 border rounded-md">
                <input type="number" id="day" placeholder="Day (1-31)" min="1" max="31" required class="w-full p-2 border rounded-md">
                <select id="timezone" class="w-full p-2 border rounded-md">
                    <option value="-12">UTC-12:00 (International Date Line West)</option>
                    <option value="-11">UTC-11:00 (Niue, Samoa)</option>
                    <option value="-10">UTC-10:00 (Hawaii)</option>
                    <option value="-9">UTC-09:00 (Alaska)</option>
                    <option value="-8">UTC-08:00 (Pacific, Los Angeles)</option>
                    <option value="-7">UTC-07:00 (Mountain, Denver)</option>
                    <option value="-6">UTC-06:00 (Central, Chicago)</option>
                    <option value="-5" selected>UTC-05:00 (Eastern, New York)</option>
                    <option value="-4">UTC-04:00 (Atlantic, Halifax)</option>
                    <option value="-3.5">UTC-03:30 (Newfoundland)</option>
                    <option value="-3">UTC-03:00 (Argentina, Brazil)</option>
                    <option value="-2">UTC-02:00 (South Georgia)</option>
                    <option value="-1">UTC-01:00 (Azores, Cape Verde)</option>
                    <option value="0">UTC±00:00 (London, GMT)</option>
                    <option value="1">UTC+01:00 (Paris, Berlin)</option>
                    <option value="2">UTC+02:00 (Cairo, Athens)</option>
                    <option value="3">UTC+03:00 (Moscow, Riyadh)</option>
                    <option value="3.5">UTC+03:30 (Iran)</option>
                    <option value="4">UTC+04:00 (Dubai)</option>
                    <option value="4.5">UTC+04:30 (Afghanistan)</option>
                    <option value="5">UTC+05:00 (Pakistan)</option>
                    <option value="5.5">UTC+05:30 (India)</option>
                    <option value="5.75">UTC+05:45 (Nepal)</option>
                    <option value="6">UTC+06:00 (Bangladesh, Bhutan)</option>
                    <option value="6.5">UTC+06:30 (Myanmar)</option>
                    <option value="7">UTC+07:00 (Bangkok, Hanoi)</option>
                    <option value="8">UTC+08:00 (Beijing, Singapore)</option>
                    <option value="9">UTC+09:00 (Tokyo, Seoul)</option>
                    <option value="9.5">UTC+09:30 (Adelaide)</option>
                    <option value="10">UTC+10:00 (Sydney, Melbourne)</option>
                    <option value="10.5">UTC+10:30 (Lord Howe Island)</option>
                    <option value="11">UTC+11:00 (Solomon Islands)</option>
                    <option value="12">UTC+12:00 (New Zealand, Fiji)</option>
                    <option value="13">UTC+13:00 (Samoa, Tokelau)</option>
                    <option value="14">UTC+14:00 (Line Islands)</option>
                </select>
                <button id="calculateBtn" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Find My Cosmic Degree</button>
            </div>
        </div>

        <div class="card bg-white p-6 rounded-lg shadow-md mb-6" id="permissionNotice" style="display: none;">
            <p class="permission-prompt font-medium">To align with the stars, allow camera and compass access when prompted.</p>
            <p class="text-sm text-gray-600">For iOS: Enable "Motion & Orientation Access" in Settings → Safari.</p>
            <button id="permissionButton" class="bg-yellow-500 text-white p-2 rounded-md hover:bg-yellow-600">Enable Permissions</button>
        </div>

        <div class="card bg-white p-6 rounded-lg shadow-md mb-6" id="results"></div>

        <div id="directionTitle" class="text-center font-medium text-blue-800">Current / Cosmic Degree</div>
        <div id="degree" class="text-center text-lg my-2">0° / --°</div>

        <div id="compass" class="mx-auto w-48 h-48 border-2 border-blue-800 rounded-full relative bg-white shadow-md mt-4">
            <div class="compass-needle-container absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center transition-transform duration-300 ease-out">
                <div class="needle text-red-600 text-2xl">↑</div>
                <div class="lucky-text text-yellow-600 font-bold text-base mt-1">LUCKY</div>
            </div>
        </div>

        <div id="camera" class="mx-auto w-64 h-64 border-2 border-blue-800 rounded-full overflow-hidden relative bg-black mt-4">
            <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
            <div id="overlay" class="absolute top-0 left-0 w-full h-full pointer-events-none">
                <div class="camera-needle-container absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center transition-transform duration-300 ease-out">
                    <div class="camera-needle text-red-600 text-3xl">↑</div>
                    <div class="camera-lucky-text text-yellow-600 font-bold text-lg mt-1 text-shadow">LUCKY</div>
                </div>
            </div>
        </div>

        <button id="installButton" class="hidden bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 mt-4">Install App</button>
        <button id="shareButton" class="w-full max-w-md bg-teal-500 text-white p-2 rounded-md hover:bg-teal-600 mt-4">Share Your Cosmic Degree</button>
    </section>

    <footer class="text-center py-6 text-sm text-gray-500">
        <p>Powered by Ancient Wisdom | For Entertainment Only</p>
        <p>© 2025 Your Lucky Compass</p>
    </footer>

    <audio id="harmonyAudio" preload="auto"></audio>

    <script>
        let compassEventListener = null;
        let lastAdjustedAngle = 0;
        let currentJoyAngle = 0;
        let hasCompassError = false;
        let hasCameraError = false;
        let rotationHintAdded = false;
        let deferredPrompt;
        let isPlaying = false;
        const audioFiles = [
            '/static/sound_bath/Bamboo Whisper.mp3',
            '/static/sound_bath/Bering Mist.mp3',
            '/static/sound_bath/Blizzard Trek.mp3',
            '/static/sound_bath/Brook Murmur.mp3',
            '/static/sound_bath/Cascade Song.mp3',
            '/static/sound_bath/Chiming Breeze.mp3',
            '/static/sound_bath/Cicada Summer.mp3',
            '/static/sound_bath/Deep Dive.mp3',
            '/static/sound_bath/Drywood Echo.mp3',
            '/static/sound_bath/Ember Glow.mp3',
            '/static/sound_bath/Falls Serenade.mp3',
            '/static/sound_bath/Frog Chorus.mp3',
            '/static/sound_bath/Gentle Drizzle.mp3',
            '/static/sound_bath/Harbor Whispers.mp3',
            '/static/sound_bath/Meadow Wander.mp3',
            '/static/sound_bath/Monsoon Breath.mp3',
            '/static/sound_bath/Ocean Pulse.mp3',
            '/static/sound_bath/Seagull Shore.mp3',
            '/static/sound_bath/Silent Clarity.mp3',
            '/static/sound_bath/Spring Shower.mp3',
            '/static/sound_bath/Starlit Night.mp3',
            '/static/sound_bath/Streamside Life.mp3',
            '/static/sound_bath/Sumatra Rain.mp3',
            '/static/sound_bath/Temple Stillness.mp3',
            '/static/sound_bath/Thunder Veil.mp3',
            '/static/sound_bath/Verdant Canopy.mp3',
            '/static/sound_bath/Wheat Sway.mp3'
        ];

        // 强制HTTPS
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
            window.location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
        }

        async function calculateBazi() {
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);
            const day = parseInt(document.getElementById('day').value);
            const timezone = document.getElementById('timezone').value;

            // 输入验证
            if (!year || !month || !day || year < 1900 || year > 2025 || month < 1 || month > 12 || day < 1 || day > 31) {
                showError("Please enter a valid date (Year: 1900-2025, Month: 1-12, Day: 1-31)");
                return;
            }
            try {
                const testDate = new Date(year, month - 1, day);
                if (testDate.getFullYear() !== year || testDate.getMonth() + 1 !== month || testDate.getDate() !== day) {
                    throw new Error();
                }
            } catch {
                showError("Invalid date (e.g., February 30 is invalid)");
                return;
            }

            try {
                const queryParams = `year=${year}&month=${month}&day=${day}&timezone=${timezone}`;
                const response = await fetch(`https://lucky-compass-backend.fly.dev/calculate?${queryParams}`);
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const data = await response.json();
                if (data.error) {
                    showError(`Error: ${data.error}`);
                    return;
                }

                document.getElementById('results').innerHTML = `
                    <p><b>Your Cosmic Calendar:</b> ${data.solar_date}</p>
                    <p><b>Your Cosmic Blueprint:</b> ${data.bazi}</p>
                    <p><b>Your Inner Spark:</b> ${data.personality}</p>
                    <p><b>Your Cosmic Whisper:</b> ${data.mystic_description}</p>
                    <p><b>Your Cosmic Degree:</b> ${data.angle}°</p>
                    <div class="mindfulness bg-gradient-to-r from-teal-100 to-pink-100 p-4 rounded-lg mt-4">
                        <p><b>Align with the Stars:</b> Your cosmic degree is your key to serenity! Guided by ${data.personality.split('.')[0].toLowerCase()}, rotate your phone to align with ${data.angle}°. Breathe deeply, let the universe’s energy flow through you, and find your inner calm.</p>
                        <p><em>Pro tip: Use your Cosmic Compass daily in a quiet moment to reconnect with the stars!</em></p>
                    </div>
                `;

                currentJoyAngle = data.angle;
                document.getElementById('degree').textContent = `0° / ${currentJoyAngle}°`;
                document.getElementById('permissionNotice').style.display = 'block';

                if (compassEventListener) {
                    window.removeEventListener("deviceorientation", compassEventListener);
                }
                tryGetPermissions();

            } catch (error) {
                showError(error.message);
            }
        }

        async function tryGetPermissions() {
            try {
                const compassGranted = await requestCompassPermission();
                if (compassGranted) {
                    await startCamera();
                }
            } catch (error) {
                console.error("Permission error:", error);
            }
        }

        async function requestCompassPermission() {
            if (!("DeviceOrientationEvent" in window)) {
                showError("Compass not supported on this device");
                return false;
            }

            try {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permissionState = await DeviceOrientationEvent.requestPermission();
                    if (permissionState !== 'granted') {
                        showError("Compass permission denied. Go to Settings → Safari → Enable 'Motion & Orientation Access'");
                        return false;
                    }
                }

                compassEventListener = function(event) {
                    const alpha = event.alpha || 0;
                    let adjustedAngle = (360 - alpha + currentJoyAngle) % 360;
                    const angleDiff = adjustedAngle - lastAdjustedAngle;
                    if (angleDiff > 180) adjustedAngle -= 360;
                    else if (angleDiff < -180) adjustedAngle += 360;
                    lastAdjustedAngle = adjustedAngle;

                    const compassNeedle = document.querySelector('.compass-needle-container');
                    const cameraNeedle = document.querySelector('.camera-needle-container');
                    if (compassNeedle) {
                        compassNeedle.style.transform = `translate(-50%, -50%) rotate(${adjustedAngle}deg)`;
                    }
                    if (cameraNeedle) {
                        cameraNeedle.style.transform = `translate(-50%, -50%) rotate(${adjustedAngle}deg)`;
                    }

                    document.getElementById('degree').textContent = `${Math.round(alpha)}° / ${currentJoyAngle}°`;

                    const diff = Math.min(Math.abs(alpha - currentJoyAngle), 360 - Math.abs(alpha - currentJoyAngle));
                    if (diff <= 10 && !isPlaying) {
                        playHarmonySound();
                    } else if (diff > 10 && isPlaying) {
                        stopHarmonySound();
                    }
                };
                window.addEventListener("deviceorientation", compassEventListener);

                if (!rotationHintAdded) {
                    showMessage("Rotate your phone to align with the LUCKY marker!");
                    rotationHintAdded = true;
                }
                return true;

            } catch (error) {
                showError("Failed to access compass. Please enable permissions.");
                return false;
            }
        }

        async function startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError("Camera not supported");
                return false;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 300 }, height: { ideal: 300 } }
                });
                const videoElement = document.getElementById('video');
                videoElement.srcObject = stream;
                videoElement.onerror = () => {
                    stream.getTracks().forEach(track => track.stop());
                };
                hasCameraError = false;
                return true;

            } catch (error) {
                let msg = "Camera access failed. Please enable permissions.";
                if (error.name === 'NotAllowedError') {
                    msg = "Camera permission denied. Check browser settings.";
                } else if (error.name === 'NotFoundError') {
                    msg = "No camera found on this device.";
                }
                showError(msg);
                return false;
            }
        }

        function showError(message) {
            const results = document.getElementById('results');
            const existingError = document.getElementById('errorContainer');
            if (existingError) {
                existingError.textContent = message;
            } else {
                results.innerHTML += `<div id="errorContainer" class="permission-prompt text-red-600">${message}</div>`;
            }
        }

        function showMessage(message) {
            document.getElementById('results').innerHTML += `<p class="text-sm text-gray-600">${message}</p>`;
        }

        function playHarmonySound() {
            if (isPlaying) return;
            const randomAudio = audioFiles[Math.floor(Math.random() * audioFiles.length)];
            const audio = document.getElementById('harmonyAudio');
            audio.src = randomAudio;
            audio.volume = 0.3;
            audio.play().then(() => {
                isPlaying = true;
            }).catch(e => console.log('Audio play failed:', e));
        }

        function stopHarmonySound() {
            if (isPlaying) {
                const audio = document.getElementById('harmonyAudio');
                audio.pause();
                audio.currentTime = 0;
                isPlaying = false;
            }
        }

        async function shareCosmicDegree() {
            try {
                await navigator.share({
                    title: 'My Cosmic Degree',
                    text: 'I found my cosmic degree with the Lucky Compass! Discover yours and align with the stars!',
                    url: window.location.href
                });
            } catch (err) {
                showError('Sharing failed: ' + err);
            }
        }

        window.addEventListener('beforeunload', () => {
            if (compassEventListener) {
                window.removeEventListener("deviceorientation", compassEventListener);
            }
            const video = document.getElementById('video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        });

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installButton').style.display = 'block';
        });

        document.getElementById('installButton').addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(choice => {
                    if (choice.outcome === 'accepted') {
                        console.log('App installed');
                    }
                    deferredPrompt = null;
                });
            }
        });

        document.getElementById('calculateBtn').addEventListener('click', calculateBazi);
        document.getElementById('permissionButton').addEventListener('click', tryGetPermissions);
        document.getElementById('shareButton').addEventListener('click', shareCosmicDegree);
    </script>
</body>
</html>
