<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e3a8a">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline'; 
        connect-src https://lucky-compass-backend.fly.dev; 
        media-src 'self' blob:; 
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src https://fonts.gstatic.com;
    ">
    <title>Lucky Direction Compass</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" type="image/png">
    <!-- 引入Roboto字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入GitHub仓库中的CSS -->
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>
    <header>
        <h1>Lucky Direction Compass</h1>
        <p>Discover your personal lucky direction based on Chinese astrology</p>
    </header>

    <nav>
        <div class="container">
            <a href="https://www.yourluckycompass.com/" class="text-white hover:underline">Home</a>
            <a href="https://www.yourluckycompass.com/bazi" class="text-white hover:underline">Bazi Reading</a>
            <a href="https://www.yourluckycompass.com/lucky-city" class="text-white hover:underline">Lucky City Match</a>
            <a href="#" class="text-white hover:underline font-bold">Lucky Compass</a>
            <a href="https://www.yourluckycompass.com/sound-bath" class="text-white hover:underline">Sound Bath</a>
        </div>
    </nav>

    <section>
        <div class="card">
            <input type="number" id="year" placeholder="Year (1900-2025)" min="1900" max="2025" required>
            <input type="number" id="month" placeholder="Month (1-12)" min="1" max="12" required>
            <input type="number" id="day" placeholder="Day (1-31)" min="1" max="31" required>
            
            <input type="number" id="hour" placeholder="Hour (0-23, optional)" min="0" max="23">
            <p class="optional-field">* Hour is optional - leave blank if unknown</p>
            <input type="number" id="minute" placeholder="Minute (0-59, optional)" min="0" max="59">
            <p class="optional-field">* Minute is optional - leave blank if unknown</p>
            
            <select id="timezone">
              <option value="-12">UTC-12:00 (International Date Line West)</option>
              <option value="-11">UTC-11:00 (Niue, Samoa)</option>
              <option value="-10">UTC-10:00 (Hawaii-Aleutian Standard Time)</option>
              <option value="-9">UTC-09:00 (Alaska Standard Time)</option>
              <option value="-8">UTC-08:00 (Pacific Standard Time)</option>
              <option value="-7">UTC-07:00 (Mountain Standard Time)</option>
              <option value="-6">UTC-06:00 (Central Standard Time)</option>
              <option value="-5">UTC-05:00 (Eastern Standard Time)</option>
              <option value="-4">UTC-04:00 (Atlantic Standard Time)</option>
              <option value="-3.5">UTC-03:30 (Newfoundland Standard Time)</option>
              <option value="-3">UTC-03:00 (Argentina, Brazil)</option>
              <option value="-2">UTC-02:00 (South Georgia & South Sandwich Islands)</option>
              <option value="-1">UTC-01:00 (Azores, Cape Verde)</option>
              <option value="0">UTC±00:00 (Greenwich Mean Time)</option>
              <option value="1">UTC+01:00 (Central European Time)</option>
              <option value="2">UTC+02:00 (Eastern European Time)</option>
              <option value="3">UTC+03:00 (Moscow Time, Arabia Standard Time)</option>
              <option value="3.5">UTC+03:30 (Iran Standard Time)</option>
              <option value="4">UTC+04:00 (Caucasus Standard Time)</option>
              <option value="4.5">UTC+04:30 (Afghanistan Time)</option>
              <option value="5">UTC+05:00 (Pakistan Standard Time)</option>
              <option value="5.5">UTC+05:30 (India Standard Time)</option>
              <option value="5.75">UTC+05:45 (Nepal Time)</option>
              <option value="6">UTC+06:00 (Bangladesh Time, Bhutan Time)</option>
              <option value="6.5">UTC+06:30 (Myanmar Time)</option>
              <option value="7">UTC+07:00 (Indochina Time)</option>
              <option value="8">UTC+08:00 (China Standard Time, Singapore Time)</option>
              <option value="9">UTC+09:00 (Japan Standard Time, Korea Standard Time)</option>
              <option value="9.5">UTC+09:30 (Australian Central Standard Time)</option>
              <option value="10">UTC+10:00 (Australian Eastern Standard Time)</option>
              <option value="10.5">UTC+10:30 (Lord Howe Island Time)</option>
              <option value="11">UTC+11:00 (Solomon Islands, Vanuatu)</option>
              <option value="12">UTC+12:00 (New Zealand Standard Time, Fiji)</option>
              <option value="13">UTC+13:00 (Samoa, Tokelau)</option>
              <option value="14">UTC+14:00 (Line Islands)</option>
           </select>

            
            <button id="calculateBtn">Find My Lucky Direction</button>
        </div>

        <div class="card" id="permissionNotice" style="display: none;">
            <p class="permission-prompt">To use all features, please allow camera and compass access when prompted.</p>
            <p class="text-sm">For iOS users: Go to Settings → Safari → Enable "Motion & Orientation Access" for this site</p>
            <button id="permissionButton" class="bg-yellow-500 hover:bg-yellow-600">Enable Permissions</button>
        </div>

        <div class="card" id="results"></div>

        <div id="directionTitle" class="text-center font-medium text-blue-800">Current / Lucky Direction</div>
        <div id="degree" class="text-center text-lg my-2">0° / --°</div>

        <!-- 指南针容器 - 修复位置问题 -->
        <div id="compass">
            <div class="compass-needle-container">
                <div class="needle">↑</div>
                <div class="lucky-text">LUCKY</div>
            </div>
        </div>

        <!-- 摄像头容器 - 修复位置问题 -->
        <div id="camera">
            <video id="video" autoplay playsinline></video>
            <div id="overlay">
                <div class="camera-needle-container">
                    <div class="needle">↑</div>
                    <div class="lucky-text">LUCKY</div>
                </div>
            </div>
        </div>

        <button id="installButton" style="display: none; margin-top: 20px;">Install App</button>
    </section>

    <footer>
        <p>© 2025 Your Lucky Compass | Chinese Astrology Tools</p>
    </footer>

    <audio id="harmonyAudio" preload="auto" loop></audio>

    <script>
        let compassEventListener = null;
        let lastAdjustedAngle = 0;
        let currentJoyAngle = 0;
        let hasCompassError = false;
        let hasCameraError = false;
        let rotationHintAdded = false;
        let deferredPrompt;
        let isPlaying = false;
        const audioFiles = [
            'sound-bath/audio/Bamboo Whisper.mp3',
            'sound-bath/audio/Bering Mist.mp3',
            'sound-bath/audio/Blizzard Trek.mp3',
            'sound-bath/audio/Brook Murmur.mp3',
            'sound-bath/audio/Cascade Song.mp3',
            'sound-bath/audio/Chiming Breeze.mp3',
            'sound-bath/audio/Cicada Summer.mp3',
            'sound-bath/audio/Deep Dive.mp3',
            'sound-bath/audio/Drywood Echo.mp3',
            'sound-bath/audio/Ember Glow.mp3',
            'sound-bath/audio/Falls Serenade.mp3',
            'sound-bath/audio/Frog Chorus.mp3',
            'sound-bath/audio/Gentle Drizzle.mp3',
            'sound-bath/audio/Harbor Whispers.mp3',
            'sound-bath/audio/Meadow Wander.mp3',
            'sound-bath/audio/Monsoon Breath.mp3',
            'sound-bath/audio/Ocean Pulse.mp3',
            'sound-bath/audio/Seagull Shore.mp3',
            'sound-bath/audio/Silent Clarity.mp3',
            'sound-bath/audio/Spring Shower.mp3',
            'sound-bath/audio/Starlit Night.mp3',
            'sound-bath/audio/Streamside Life.mp3',
            'sound-bath/audio/Sumatra Rain.mp3',
            'sound-bath/audio/Temple Stillness.mp3',
            'sound-bath/audio/Thunder Veil.mp3',
            'sound-bath/audio/Verdant Canopy.mp3',
            'sound-bath/audio/Wheat Sway.mp3'
        ];

        // 强制HTTPS
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
            window.location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
        }

        async function calculateBazi() {
            // 获取输入值
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);
            const day = parseInt(document.getElementById('day').value);
            const hour = document.getElementById('hour').value ? parseInt(document.getElementById('hour').value) : null;
            const minute = document.getElementById('minute').value ? parseInt(document.getElementById('minute').value) : null;
            const timezone = document.getElementById('timezone').value;

            // 输入验证
            if (!year || !month || !day || year < 1900 || year > 2025 || month < 1 || month > 12 || day < 1 || day > 31) {
                alert("Please enter a valid date (1900-2025)");
                return;
            }
            if (hour !== null && (hour < 0 || hour > 23)) {
                alert("Hour must be 0-23 or blank");
                return;
            }
            if (minute !== null && (minute < 0 || minute > 59)) {
                alert("Minute must be 0-59 or blank");
                return;
            }
            try {
                const testDate = new Date(year, month - 1, day);
                if (testDate.getFullYear() !== year || testDate.getMonth() + 1 !== month || testDate.getDate() !== day) {
                    throw new Error();
                }
            } catch {
                alert("Invalid date (e.g., February 30 is invalid)");
                return;
            }

            // 调用API
            try {
                let queryParams = `year=${year}&month=${month}&day=${day}&timezone=${timezone}`;
                if (hour !== null) queryParams += `&hour=${hour}`;
                if (minute !== null) queryParams += `&minute=${minute}`;

                const response = await fetch(`https://lucky-compass-backend.fly.dev/calculate?${queryParams}`);
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const data = await response.json();
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    return;
                }

                // 显示结果
                document.getElementById('results').innerHTML = `
                    <p><b>Your Cosmic Calendar:</b> ${data.solar_date}</p>
                    <p><b>Your Destiny Blueprint (BaZi):</b> ${data.bazi}</p>
                    <p><b>Your Inner Spark:</b> ${data.personality}</p>
                    <p><b>Daily Cosmic Whisper:</b> ${data.mystic_description}</p>
                    <p><b>Your Lucky Degree:</b> ${data.angle}°</p>
                    <div class="mindfulness bg-gradient-to-r from-teal-100 to-pink-100 p-4 rounded-lg mt-4">
                        <p><b>Mindful Alignment:</b> Your lucky degree is your cosmic key to inner peace! Guided by the stars' gentle wisdom, slowly rotate your phone to align with your cosmic degree. Breathe deeply, feel the universe's harmony flowing through you, inviting calm and clarity. Let this alignment anchor you in serene presence, releasing daily stress for profound tranquility.</p>
                        <p><em>Pro tip: Revisit your Lucky Compass daily—your cosmic key evolves with the stars!</em></p>
                    </div>
                `;

                currentJoyAngle = data.angle;
                document.getElementById('degree').textContent = `0° / ${currentJoyAngle}°`;
                document.getElementById('permissionNotice').style.display = 'block';

                // 清理旧监听器
                if (compassEventListener) {
                    window.removeEventListener("deviceorientation", compassEventListener);
                }

                // 请求权限
                tryGetPermissions();

            } catch (error) {
                document.getElementById('results').innerHTML = `<p class="permission-prompt">${error.message}</p>`;
            }
        }

        async function tryGetPermissions() {
            try {
                const compassGranted = await requestCompassPermission();
                if (compassGranted) {
                    await startCamera();
                }
            } catch (error) {
                console.error("Permission error:", error);
            }
        }

        async function requestCompassPermission() {
            if (!("DeviceOrientationEvent" in window)) {
                showError("Compass not supported on this device");
                return false;
            }

            try {
                // iOS Safari 特殊处理
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permissionState = await DeviceOrientationEvent.requestPermission();
                    if (permissionState !== 'granted') {
                        showError("Compass permission denied. Go to Settings → Safari → Enable 'Motion & Orientation Access'");
                        return false;
                    }
                }

                // 绑定指南针监听器 - 修复箭头位置计算
                compassEventListener = function(event) {
                    const alpha = event.alpha || 0;
                    // 修复角度计算，确保箭头在指南针范围内
                    let adjustedAngle = (360 - alpha + currentJoyAngle) % 360;
                    
                    // 最短路径旋转优化
                    const angleDiff = adjustedAngle - lastAdjustedAngle;
                    if (angleDiff > 180) adjustedAngle -= 360;
                    else if (angleDiff < -180) adjustedAngle += 360;
                    
                    lastAdjustedAngle = adjustedAngle;
                    
                    // 应用旋转，确保箭头在容器内
                    const compassNeedle = document.querySelector('.compass-needle-container');
                    const cameraNeedle = document.querySelector('.camera-needle-container');
                    
                    if (compassNeedle) {
                        compassNeedle.style.transform = `translate(-50%, -50%) rotate(${adjustedAngle}deg)`;
                    }
                    if (cameraNeedle) {
                        cameraNeedle.style.transform = `translate(-50%, -50%) rotate(${adjustedAngle}deg)`;
                    }
                    
                    document.getElementById('degree').textContent = `${Math.round(alpha)}° / ${currentJoyAngle}°`;

                    // 播放音效
                    const diff = Math.min(Math.abs(alpha - currentJoyAngle), 360 - Math.abs(alpha - currentJoyAngle));
                    if (diff <= 10 && !isPlaying) {
                        playHarmonySound();
                    } else if (diff > 10 && isPlaying) {
                        stopHarmonySound();
                    }
                };
                window.addEventListener("deviceorientation", compassEventListener);

                if (!rotationHintAdded) {
                    showMessage("Rotate your phone to align with the LUCKY marker!");
                    rotationHintAdded = true;
                }
                return true;

            } catch (error) {
                showError("Failed to access compass. Please enable permissions.");
                return false;
            }
        }

        async function startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError("Camera not supported");
                return false;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 300 },
                        height: { ideal: 300 }
                    }
                });
                const videoElement = document.getElementById('video');
                videoElement.srcObject = stream;
                videoElement.onerror = () => {
                    stream.getTracks().forEach(track => track.stop());
                };
                hasCameraError = false;
                return true;

            } catch (error) {
                let msg = "Camera access failed. Please enable permissions.";
                if (error.name === 'NotAllowedError') {
                    msg = "Camera permission denied. Check browser settings.";
                } else if (error.name === 'NotFoundError') {
                    msg = "No camera found on this device.";
                }
                showError(msg);
                return false;
            }
        }

        // 工具函数
        function showError(message) {
            const results = document.getElementById('results');
            const existingError = document.getElementById('errorContainer');
            
            if (existingError) {
                existingError.textContent = message;
            } else {
                results.innerHTML += `<div id="errorContainer" class="permission-prompt">${message}</div>`;
            }
        }

        function showMessage(message) {
            document.getElementById('results').innerHTML += `<p>${message}</p>`;
        }

        // 音效播放
        function playHarmonySound() {
            if (isPlaying) return;
            const randomAudio = audioFiles[Math.floor(Math.random() * audioFiles.length)];
            const audio = document.getElementById('harmonyAudio');
            audio.src = randomAudio;
            audio.volume = 0.3;
            audio.play().then(() => {
                isPlaying = true;
            }).catch(e => console.log('Audio play failed:', e));
        }

        function stopHarmonySound() {
            if (isPlaying) {
                const audio = document.getElementById('harmonyAudio');
                audio.pause();
                audio.currentTime = 0;
                isPlaying = false;
            }
        }

        // 页面切换时保持音效
        window.addEventListener('beforeunload', () => {
            if (isPlaying && !window.location.pathname.includes('sound-bath')) {
                sessionStorage.setItem('harmonyPlaying', 'true');
                sessionStorage.setItem('harmonySrc', document.getElementById('harmonyAudio').src);
            } else {
                sessionStorage.removeItem('harmonyPlaying');
                sessionStorage.removeItem('harmonySrc');
            }
        });

        window.addEventListener('load', () => {
            if (sessionStorage.getItem('harmonyPlaying') === 'true' && !window.location.pathname.includes('sound-bath')) {
                const src = sessionStorage.getItem('harmonySrc');
                if (src) {
                    const audio = document.getElementById('harmonyAudio');
                    audio.src = src;
                    audio.volume = 0.3;
                    audio.play().then(() => {
                        isPlaying = true;
                    }).catch(e => console.log('Audio play failed:', e));
                }
            }
        });

        // 页面清理
        window.addEventListener('beforeunload', () => {
            if (compassEventListener) {
                window.removeEventListener("deviceorientation", compassEventListener);
            }
            const video = document.getElementById('video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        });

        // PWA安装
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installButton').style.display = 'block';
        });

        document.getElementById('installButton').addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(choice => {
                    if (choice.outcome === 'accepted') {
                        console.log('App installed');
                    }
                    deferredPrompt = null;
                });
            }
        });

        // 事件绑定
        document.getElementById('calculateBtn').addEventListener('click', calculateBazi);
        document.getElementById('permissionButton').addEventListener('click', tryGetPermissions);
    </script>
</body>
</html>
