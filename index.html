<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e3a8a">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline'; 
        connect-src https://lucky-compass-backend.fly.dev; 
        media-src 'self' blob:; 
        style-src 'self' 'unsafe-inline';
    ">
    <title>Lucky Direction Compass</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f3f4f6;
            font-family: Arial, sans-serif;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #1e3a8a;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #1e40af;
        }
        #compass, #camera {
            width: 280px;
            height: 280px;
            margin: 20px auto;
            border-radius: 50%;
            position: relative;
        }
        .needle {
            color: red;
            font-size: 36px;
        }
        .permission-prompt {
            color: #dc2626;
            padding: 10px;
            background: #fee2e2;
            border-radius: 4px;
            margin: 10px 0;
        }
        .optional-field {
            font-size: 12px;
            color: #666;
            margin-top: -6px;
        }
    </style>
</head>
<body class="container">
    <nav class="bg-white shadow-md p-4 mb-6">
        <div class="flex justify-center space-x-4">
            <a href="#" class="text-blue-600 hover:underline">Home</a>
            <a href="#" class="text-blue-600 hover:underline">Bazi Reading</a>
            <a href="#" class="text-blue-600 hover:underline font-bold">Lucky Compass</a>
        </div>
    </nav>

    <div class="card">
        <h1 class="text-2xl font-bold text-center mb-4">Find Your Lucky Direction</h1>
        <p class="text-center mb-6">Discover your personal lucky direction based on Chinese astrology</p>
        
        <input type="number" id="year" placeholder="Year (1900-2025)" min="1900" max="2025" required>
        <input type="number" id="month" placeholder="Month (1-12)" min="1" max="12" required>
        <input type="number" id="day" placeholder="Day (1-31)" min="1" max="31" required>
        
        <input type="number" id="hour" placeholder="Hour (0-23, optional)" min="0" max="23">
        <p class="optional-field">* Hour is optional - leave blank if unknown</p>
        <input type="number" id="minute" placeholder="Minute (0-59, optional)" min="0" max="59">
        <p class="optional-field">* Minute is optional - leave blank if unknown</p>
        
        <select id="timezone">
            <option value="-12">UTC-12:00 (Baker Island)</option>
            <option value="-11">UTC-11:00 (Samoa)</option>
            <option value="-10">UTC-10:00 (Hawaii)</option>
            <option value="-8" selected>UTC-08:00 (Pacific Time)</option>
            <option value="0">UTC+00:00 (London)</option>
            <option value="8">UTC+08:00 (Beijing, Singapore)</option>
            <!-- 补充完整时区列表 -->
        </select>
        
        <button id="calculateBtn">Find My Lucky Direction</button>
    </div>

    <div class="card" id="permissionNotice" style="display: none;">
        <p class="permission-prompt">To use all features, please allow camera and compass access when prompted.</p>
        <p class="text-sm">For iOS users: Go to Settings → Safari → Enable "Motion & Orientation Access" for this site</p>
        <button id="permissionButton" class="bg-yellow-500 hover:bg-yellow-600">Enable Permissions</button>
    </div>

    <div class="card" id="results"></div>

    <div id="directionTitle" class="text-center font-medium text-blue-800">Current / Lucky Direction</div>
    <div id="degree" class="text-center text-lg my-2">0° / --°</div>

    <div id="compass" class="border-2 border-blue-800 bg-white">
        <div class="compass-needle-container absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center transition-transform duration-300">
            <div class="needle">↑</div>
            <div class="lucky-text text-yellow-600 font-bold">LUCKY</div>
        </div>
    </div>

    <div id="camera" class="border-2 border-blue-800 bg-black overflow-hidden">
        <video id="video" autoplay playsinline></video>
        <div id="overlay" class="absolute inset-0 pointer-events-none">
            <div class="camera-needle-container absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center transition-transform duration-300">
                <div class="needle">↑</div>
                <div class="lucky-text text-yellow-600 font-bold">LUCKY</div>
            </div>
        </div>
    </div>

    <button id="installButton" style="display: none; margin-top: 20px;">Install App</button>

    <script>
        let compassEventListener = null;
        let lastAdjustedAngle = 0;
        let currentJoyAngle = 0;
        let hasCompassError = false;
        let hasCameraError = false;
        let rotationHintAdded = false;
        let deferredPrompt;

        // 强制HTTPS
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
            window.location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
        }

        async function calculateBazi() {
            // 获取输入值
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);
            const day = parseInt(document.getElementById('day').value);
            const hour = document.getElementById('hour').value ? parseInt(document.getElementById('hour').value) : null;
            const minute = document.getElementById('minute').value ? parseInt(document.getElementById('minute').value) : null;
            const timezone = document.getElementById('timezone').value;

            // 输入验证
            if (!year || !month || !day || year < 1900 || year > 2025 || month < 1 || month > 12 || day < 1 || day > 31) {
                alert("Please enter a valid date (1900-2025)");
                return;
            }
            if (hour !== null && (hour < 0 || hour > 23)) {
                alert("Hour must be 0-23 or blank");
                return;
            }
            if (minute !== null && (minute < 0 || minute > 59)) {
                alert("Minute must be 0-59 or blank");
                return;
            }
            try {
                const testDate = new Date(year, month - 1, day);
                if (testDate.getFullYear() !== year || testDate.getMonth() + 1 !== month || testDate.getDate() !== day) {
                    throw new Error();
                }
            } catch {
                alert("Invalid date (e.g., February 30 is invalid)");
                return;
            }

            // 调用API
            try {
                let queryParams = `year=${year}&month=${month}&day=${day}&timezone=${timezone}`;
                if (hour !== null) queryParams += `&hour=${hour}`;
                if (minute !== null) queryParams += `&minute=${minute}`;

                const response = await fetch(`https://lucky-compass-backend.fly.dev/calculate?${queryParams}`);
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const data = await response.json();
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    return;
                }

                // 显示结果（包含28星宿在八字和宇宙密码之间）
                document.getElementById('results').innerHTML = `
                    <p><b>Lunar Date:</b> ${data.lunar_date}</p>
                    <p><b>BaZi:</b> ${data.bazi}</p>
                    <p><b>Lunar Mansion:</b> ${data.mansion}</p>
                    <p><b>Cosmic Code:</b> ${data.mystic_description}</p>
                    <p><b>Lucky Direction:</b> ${data.joy_direction} (${data.angle}°)</p>
                `;

                currentJoyAngle = data.angle;
                document.getElementById('degree').textContent = `0° / ${currentJoyAngle}°`;
                document.getElementById('permissionNotice').style.display = 'block';

                // 清理旧监听器
                if (compassEventListener) {
                    window.removeEventListener("deviceorientation", compassEventListener);
                }

                // 请求权限
                tryGetPermissions();

            } catch (error) {
                document.getElementById('results').innerHTML = `<p class="permission-prompt">${error.message}</p>`;
            }
        }

        // 权限处理（针对苹果手机优化）
        async function tryGetPermissions() {
            try {
                const compassGranted = await requestCompassPermission();
                if (compassGranted) {
                    await startCamera();
                }
            } catch (error) {
                console.error("Permission error:", error);
            }
        }

        async function requestCompassPermission() {
            if (!("DeviceOrientationEvent" in window)) {
                showError("Compass not supported on this device");
                return false;
            }

            try {
                // iOS Safari 特殊处理
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permissionState = await DeviceOrientationEvent.requestPermission();
                    if (permissionState !== 'granted') {
                        showError("Compass permission denied. Go to Settings → Safari → Enable 'Motion & Orientation Access'");
                        return false;
                    }
                }

                // 绑定指南针监听器
                compassEventListener = function(event) {
                    const alpha = event.alpha || 0;
                    let adjustedAngle = (360 - alpha + currentJoyAngle) % 360;
                    
                    // 最短路径旋转优化
                    const angleDiff = adjustedAngle - lastAdjustedAngle;
                    if (angleDiff > 180) adjustedAngle -= 360;
                    else if (angleDiff < -180) adjustedAngle += 360;
                    
                    lastAdjustedAngle = adjustedAngle;
                    document.querySelector('.compass-needle-container').style.transform = 
                        `translate(-50%, -50%) rotate(${adjustedAngle}deg)`;
                    document.querySelector('.camera-needle-container').style.transform = 
                        `translate(-50%, -50%) rotate(${adjustedAngle}deg)`;
                    document.getElementById('degree').textContent = `${Math.round(alpha)}° / ${currentJoyAngle}°`;
                };
                window.addEventListener("deviceorientation", compassEventListener);

                if (!rotationHintAdded) {
                    showMessage("Rotate your phone to align with the LUCKY marker!");
                    rotationHintAdded = true;
                }
                return true;

            } catch (error) {
                showError("Failed to access compass. Please enable permissions.");
                return false;
            }
        }

        async function startCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError("Camera not supported");
                return false;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 300 },
                        height: { ideal: 300 }
                    }
                });
                const videoElement = document.getElementById('video');
                videoElement.srcObject = stream;
                videoElement.onerror = () => {
                    stream.getTracks().forEach(track => track.stop());
                };
                hasCameraError = false;
                return true;

            } catch (error) {
                let msg = "Camera access failed. Please enable permissions.";
                if (error.name === 'NotAllowedError') {
                    msg = "Camera permission denied. Check browser settings.";
                } else if (error.name === 'NotFoundError') {
                    msg = "No camera found on this device.";
                }
                showError(msg);
                return false;
            }
        }

        // 工具函数
        function showError(message) {
            document.getElementById('errorContainer') || (document.getElementById('results').innerHTML += 
                `<div id="errorContainer" class="permission-prompt">${message}</div>`);
        }

        function showMessage(message) {
            document.getElementById('results').innerHTML += `<p>${message}</p>`;
        }

        // 页面清理
        window.addEventListener('beforeunload', () => {
            if (compassEventListener) {
                window.removeEventListener("deviceorientation", compassEventListener);
            }
            const video = document.getElementById('video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        });

        // PWA安装
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installButton').style.display = 'block';
        });

        document.getElementById('installButton').addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(choice => {
                    if (choice.outcome === 'accepted') {
                        console.log('App installed');
                    }
                    deferredPrompt = null;
                });
            }
        });

        // 事件绑定
        document.getElementById('calculateBtn').addEventListener('click', calculateBazi);
        document.getElementById('permissionButton').addEventListener('click', tryGetPermissions);
    </script>
</body>
</html>
