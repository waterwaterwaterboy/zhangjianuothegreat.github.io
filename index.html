<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Direction Compass</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        header {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        nav {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.2);
            transition: background 0.3s;
        }
        nav a:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        h1 {
            color: white;
            margin: 0;
        }
        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            margin: 0.5rem 0;
        }
        .container {
            max-width: 600px;
            width: 90%;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin: 1rem;
        }
        form {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        label {
            font-weight: bold;
            color: #555;
        }
        input, select {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.05);
        }
        .permissions {
            background: #f0f8ff;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
        }
        .compass-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 2rem auto;
            border-radius: 50%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        .compass {
            position: relative;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff6b6b);
            transform: rotate(0deg);
        }
        .needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 120px;
            background: #333;
            transform-origin: bottom center;
            transform: translate(-50%, -100%);
        }
        .lucky-marker {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: gold;
            border-radius: 50%;
            box-shadow: 0 0 10px gold;
        }
        .directions {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
        }
        .direction {
            font-weight: bold;
            color: #333;
            transform: rotate(-90deg);
        }
        .result {
            text-align: center;
            margin-top: 2rem;
            line-height: 1.6;
        }
        .result h2 {
            color: #667eea;
        }
        .mindfulness {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 1.5rem;
            border-radius: 15px;
            margin-top: 1rem;
            font-style: italic;
            color: #555;
        }
        .install-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 1rem;
            font-size: 1rem;
        }
        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            margin-top: auto;
            padding: 1rem;
        }
        @media (max-width: 600px) {
            .compass-container {
                width: 250px;
                height: 250px;
            }
            .compass {
                width: 200px;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Lucky Direction Compass</h1>
        <p class="subtitle">Discover your personal lucky direction based on Chinese astrology</p>
        <nav>
            <a href="https://www.yourluckycompass.com/">Home</a>
            <a href="https://www.yourluckycompass.com/bazi">Bazi Reading</a>
            <a href="https://www.yourluckycompass.com/lucky-city">Lucky City Match</a>
            <a href="#">Lucky Compass</a>
            <a href="https://www.yourluckycompass.com/sound-bath">Sound Bath</a>
        </nav>
    </header>

    <div class="container">
        <form id="birthForm">
            <label for="year">Year:</label>
            <input type="number" id="year" required min="1900" max="2025">

            <label for="month">Month:</label>
            <input type="number" id="month" required min="1" max="12">

            <label for="day">Day:</label>
            <input type="number" id="day" required min="1" max="31">

            <label for="hour">Hour (optional):</label>
            <input type="number" id="hour" min="0" max="23">

            <label for="minute">Minute (optional):</label>
            <input type="number" id="minute" min="0" max="59">

            <label for="timezone">Timezone:</label>
            <select id="timezone">
                <option value="-12">UTC-12:00 (Baker Island)</option>
                <option value="-11">UTC-11:00 (Samoa)</option>
                <option value="-10">UTC-10:00 (Hawaii)</option>
                <option value="-8">UTC-08:00 (Pacific Time)</option>
                <option value="0">UTC+00:00 (London)</option>
                <option value="8" selected>UTC+08:00 (Beijing, Singapore)</option>
            </select>

            <button type="submit">Find My Lucky Direction</button>
        </form>

        <div class="permissions" id="permissions" style="display: none;">
            To use all features, please allow camera and compass access when prompted.<br>
            For iOS users: Go to Settings → Safari → Enable "Motion & Orientation Access" for this site<br>
            <button onclick="requestPermissions()">Enable Permissions</button>
        </div>

        <div class="result" id="result" style="display: none;">
            <h2 id="cosmicCalendar"></h2>
            <p><strong>Your Destiny Blueprint (BaZi):</strong> <span id="bazi"></span></p>
            <p><strong>Your Inner Spark:</strong> <span id="personality"></span></p>
            <p><strong>Daily Cosmic Whisper:</strong> <span id="mystic"></span></p>
            <h3>Your Lucky Degree: <span id="luckyDegree">--°</span></h3>
            <div class="compass-container">
                <div class="compass" id="compass">
                    <div class="needle" id="needle"></div>
                    <div class="lucky-marker"></div>
                    <div class="directions">
                        <div class="direction">N</div>
                        <div class="direction">E</div>
                        <div class="direction">S</div>
                        <div class="direction">W</div>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 1rem; font-size: 1.2rem;">
                    Current / Lucky Direction<br>
                    <span id="currentLucky">0° / --°</span>
                </p>
                <p style="text-align: center;">
                    ↑<br>
                    <strong>ALIGN HERE FOR HARMONY</strong>
                </p>
            </div>
            <div class="mindfulness">
                <strong>Mindful Alignment:</strong> Your lucky degree is your cosmic key to inner peace! Guided by the stars' gentle wisdom, slowly rotate your phone to align with your cosmic degree. Breathe deeply, feel the subtle harmony of the universe flowing through you, inviting calm and clarity into every moment. Let this alignment anchor you in serene presence, releasing the day's noise for profound tranquility.<br><br>
                <em>Pro tip: Revisit your Lucky Compass daily—your cosmic key evolves with the stars, deepening your mindfulness practice wherever life takes you!</em>
            </div>
            <button class="install-btn" onclick="installApp()">Install App</button>
        </div>
    </div>

    <footer class="footer">
        © 2025 Your Lucky Compass | Chinese Astrology Tools
    </footer>

    <audio id="harmonyAudio" preload="auto" loop></audio>

    <script>
        let audioContext;
        let isPlaying = false;
        const audioFiles = [
            'sound-bath/audio/Bamboo Whisper.mp3',
            'sound-bath/audio/Bering Mist.mp3',
            'sound-bath/audio/Blizzard Trek.mp3',
            'sound-bath/audio/Brook Murmur.mp3',
            'sound-bath/audio/Cascade Song.mp3',
            'sound-bath/audio/Chiming Breeze.mp3',
            'sound-bath/audio/Cicada Summer.mp3',
            'sound-bath/audio/Deep Dive.mp3',
            'sound-bath/audio/Drywood Echo.mp3',
            'sound-bath/audio/Ember Glow.mp3',
            'sound-bath/audio/Falls Serenade.mp3',
            'sound-bath/audio/Frog Chorus.mp3',
            'sound-bath/audio/Gentle Drizzle.mp3',
            'sound-bath/audio/Harbor Whispers.mp3',
            'sound-bath/audio/Meadow Wander.mp3',
            'sound-bath/audio/Monsoon Breath.mp3',
            'sound-bath/audio/Ocean Pulse.mp3',
            'sound-bath/audio/Seagull Shore.mp3',
            'sound-bath/audio/Silent Clarity.mp3',
            'sound-bath/audio/Spring Shower.mp3',
            'sound-bath/audio/Starlit Night.mp3',
            'sound-bath/audio/Streamside Life.mp3',
            'sound-bath/audio/Sumatra Rain.mp3',
            'sound-bath/audio/Temple Stillness.mp3',
            'sound-bath/audio/Thunder Veil.mp3',
            'sound-bath/audio/Verdant Canopy.mp3',
            'sound-bath/audio/Wheat Sway.mp3'
        ];

        function requestPermissions() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(permissionState => {
                    if (permissionState === 'granted') {
                        initCompass();
                    }
                });
            } else {
                initCompass();
            }
            document.getElementById('permissions').style.display = 'none';
        }

        function initCompass() {
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function handleOrientation(event) {
            const alpha = event.alpha ? Math.round(event.alpha) : 0;
            document.getElementById('currentLucky').textContent = `${alpha}° / ${document.getElementById('luckyDegree').textContent}`;
            const needle = document.getElementById('needle');
            needle.style.transform = `translate(-50%, -100%) rotate(${alpha}deg)`;

            const luckyDegree = parseFloat(document.getElementById('luckyDegree').textContent);
            if (!isNaN(luckyDegree)) {
                const diff = Math.min(Math.abs(alpha - luckyDegree), 360 - Math.abs(alpha - luckyDegree));
                if (diff <= 10) {  // Within 10 degrees
                    if (!isPlaying) {
                        playHarmonySound();
                    }
                } else {
                    stopHarmonySound();
                }
            }
        }

        function playHarmonySound() {
            if (isPlaying) return;
            const randomAudio = audioFiles[Math.floor(Math.random() * audioFiles.length)];
            const audio = new Audio(randomAudio);
            audio.loop = true;
            audio.volume = 0.3;
            audio.play().then(() => {
                isPlaying = true;
                audioContext = audio;
            }).catch(e => console.log('Audio play failed:', e));
        }

        function stopHarmonySound() {
            if (isPlaying && audioContext) {
                audioContext.pause();
                audioContext = null;
                isPlaying = false;
            }
        }

        // Persist audio across pages (using sessionStorage)
        window.addEventListener('beforeunload', () => {
            if (isPlaying) {
                sessionStorage.setItem('harmonyPlaying', 'true');
                sessionStorage.setItem('harmonySrc', audioContext ? audioContext.src : '');
            } else {
                sessionStorage.removeItem('harmonyPlaying');
            }
        });

        window.addEventListener('load', () => {
            if (sessionStorage.getItem('harmonyPlaying') === 'true') {
                const src = sessionStorage.getItem('harmonySrc');
                if (src) {
                    const audio = new Audio(src);
                    audio.loop = true;
                    audio.volume = 0.3;
                    audio.play().then(() => {
                        isPlaying = true;
                        audioContext = audio;
                    });
                }
            }
        });

        document.getElementById('birthForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const params = new URLSearchParams();
            for (const [key, value] of formData) {
                params.append(key, value);
            }

            try {
                const response = await fetch(`/calculate?${params}`);
                const data = await response.json();
                if (data.error) {
                    alert(data.error);
                    return;
                }

                document.getElementById('cosmicCalendar').textContent = `Your Cosmic Calendar: ${data.solar_date}`;
                document.getElementById('bazi').textContent = data.bazi;
                document.getElementById('personality').textContent = data.personality;
                document.getElementById('mystic').textContent = data.mystic_description;
                document.getElementById('luckyDegree').textContent = data.angle;

                document.getElementById('result').style.display = 'block';
                document.getElementById('permissions').style.display = 'block';
                requestPermissions();
            } catch (error) {
                alert('Calculation failed: ' + error.message);
            }
        });

        function installApp() {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                // Placeholder for PWA install
                alert('PWA installation prompt would appear here. Check your browser console for details.');
            }
        }
    </script>
</body>
</html>
