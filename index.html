<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Discover your lucky direction with our exclusive Chinese astrology compass, blending your birth date, Five Elements, and real-time geographic positioning for cosmic success.">
    <meta name="keywords" content="lucky direction, Chinese astrology compass, Bazi direction, personal luck">
    <meta name="theme-color" content="#1e3a8a">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-hashes' 'unsafe-inline'; 
        script-src-attr 'self' 'unsafe-hashes' 'unsafe-inline'; 
        connect-src https://lucky-compass-backend.fly.dev https://*.fly.dev http://localhost:8080; 
        img-src 'self' data:; 
        media-src 'self' blob: https://zhangjianuothegreat.github.io https://yourluckycompass.com; 
        style-src 'self' 'unsafe-inline';
        worker-src 'self' blob:;
        frame-src 'self' blob:;
    ">
    <title>Find Your Lucky Direction - Your Lucky Compass</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="bg-gray-100 font-sans text-gray-800">
    <nav class="bg-white shadow-md p-4">
        <div class="container mx-auto flex justify-center space-x-4">
            <a href="https://www.yourluckycompass.com/" class="text-blue-600 hover:text-blue-700">Home</a>
            <a href="https://www.yourluckycompass.com/bazi" class="text-blue-600 hover:text-blue-700">Bazi Reading</a>
            <a href="https://www.yourluckycompass.com/lucky_city" class="text-blue-600 hover:text-blue-700">Lucky City Match</a>
            <a href="https://www.yourluckycompass.com/lucky_compass" class="text-blue-600 hover:text-blue-700 font-bold">Lucky Compass</a>
            <a href="https://www.yourluckycompass.com/sound_bath" class="text-blue-600 hover:text-blue-700">Sound Bath</a>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-800">Find Your Lucky Direction</h1>
            <p class="mt-2 text-lg">Discover the direction that boosts your luck based on your birth date and real-time geographic positioning!</p>
        </header>

        <section class="bg-white p-6 rounded-lg shadow-md mb-6">
            <p class="mb-4">Unlock the secrets of your destiny with our exclusive Lucky Compass! Rooted in 3,000 years of Chinese astrology, our cutting-edge algorithm blends your birth date, Five Elements balance, and real-time geographic positioning with the ancient art of Wu Xing (Five Phases) to reveal your personal lucky direction. Watch the compass dynamically align with the cosmos, guiding you to success and harmony—way beyond any ordinary app!</p>
            <div class="space-y-4">
                <input type="number" id="year" placeholder="Year (e.g., 1984)" min="1900" max="2100" class="w-full max-w-xs p-2 border rounded-md">
                <input type="number" id="month" placeholder="Month (1-12)" min="1" max="12" class="w-full max-w-xs p-2 border rounded-md">
                <input type="number" id="day" placeholder="Day (1-31)" min="1" max="31" class="w-full max-w-xs p-2 border rounded-md">
                <input type="number" id="hour" placeholder="Hour (0-23, optional)" min="0" max="23" class="w-full max-w-xs p-2 border rounded-md">
                <input type="number" id="minute" placeholder="Minute (0-59, optional)" min="0" max="59" class="w-full max-w-xs p-2 border rounded-md">
                <select id="timezone" class="w-full max-w-xs p-2 border rounded-md">
                    <option value="-12">UTC-12:00 (Baker Island, Howland Island)</option>
                    <option value="-11">UTC-11:00 (American Samoa, Niue)</option>
                    <option value="-10">UTC-10:00 (Hawaii)</option>
                    <option value="-9.5">UTC-09:30 (Marquesas Islands)</option>
                    <option value="-9">UTC-09:00 (Alaska)</option>
                    <option value="-8">UTC-08:00 (Pacific Time, Baja California)</option>
                    <option value="-7">UTC-07:00 (Mountain Time)</option>
                    <option value="-6">UTC-06:00 (Central Time, Saskatchewan)</option>
                    <option value="-5">UTC-05:00 (Eastern Time, Bogota, Lima)</option>
                    <option value="-4.5">UTC-04:30 (Venezuela)</option>
                    <option value="-4">UTC-04:00 (Atlantic Time, Santiago, La Paz)</option>
                    <option value="-3.5">UTC-03:30 (Newfoundland)</option>
                    <option value="-3">UTC-03:00 (Buenos Aires, Sao Paulo, Greenland)</option>
                    <option value="-2">UTC-02:00 (South Georgia and the South Sandwich Islands)</option>
                    <option value="-1">UTC-01:00 (Azores, Cape Verde Islands)</option>
                    <option value="0">UTC±00:00 (London, Dublin, Lisbon, Reykjavik)</option>
                    <option value="1">UTC+01:00 (Paris, Berlin, Rome, Lagos, Johannesburg)</option>
                    <option value="2">UTC+02:00 (Istanbul, Cairo, Johannesburg, Athens)</option>
                    <option value="3">UTC+03:00 (Moscow, Kuwait, Riyadh, Nairobi)</option>
                    <option value="3.5">UTC+03:30 (Tehran)</option>
                    <option value="4">UTC+04:00 (Dubai, Baku, Tbilisi)</option>
                    <option value="4.5">UTC+04:30 (Kabul)</option>
                    <option value="5">UTC+05:00 (Islamabad, Karachi, Tashkent)</option>
                    <option value="5.5">UTC+05:30 (New Delhi, Colombo)</option>
                    <option value="5.75">UTC+05:45 (Kathmandu)</option>
                    <option value="6">UTC+06:00 (Dhaka, Astana)</option>
                    <option value="6.5">UTC+06:30 (Yangon)</option>
                    <option value="7">UTC+07:00 (Bangkok, Hanoi, Jakarta)</option>
                    <option value="8" selected>UTC+08:00 (Beijing, Singapore, Hong Kong, Perth)</option>
                    <option value="8.75">UTC+08:45 (Eucla)</option>
                    <option value="9">UTC+09:00 (Tokyo, Seoul, Osaka, Yakutsk)</option>
                    <option value="9.5">UTC+09:30 (Adelaide, Darwin)</option>
                    <option value="10">UTC+10:00 (Sydney, Melbourne, Vladivostok)</option>
                    <option value="10.5">UTC+10:30 (Lord Howe Island)</option>
                    <option value="11">UTC+11:00 (Brisbane, Solomon Islands, New Caledonia)</option>
                    <option value="11.5">UTC+11:30 (Norfolk Island)</option>
                    <option value="12">UTC+12:00 (Auckland, Wellington, Fiji, Kamchatka)</option>
                    <option value="12.75">UTC+12:45 (Chatham Islands)</option>
                    <option value="13">UTC+13:00 (Samoa, Tonga)</option>
                    <option value="14">UTC+14:00 (Line Islands)</option>
                </select>
                <button id="calculateBtn" class="w-full max-w-xs bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Find My Lucky Direction</button>
            </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div id="permissionNotice" class="hidden bg-yellow-50 p-4 rounded-md border border-yellow-400 text-yellow-800">
                To use all features, please allow access to your device's orientation (compass) and camera.
                <button id="permissionButton" class="mt-2 bg-yellow-500 text-white p-2 rounded-md hover:bg-yellow-600">Allow Permissions</button>
            </div>

            <div id="results" class="text-left max-w-xs mx-auto p-4 bg-gray-50 rounded-md">
                <div id="errorContainer"></div>
            </div>

            <div id="directionTitle" class="text-blue-800 font-medium mt-4">Current Direction / Lucky Direction</div>
            <div id="degree" class="text-blue-800 text-lg mt-2">0° / --°</div>

            <div id="compass" class="mx-auto w-48 h-48 border-2 border-blue-800 rounded-full relative bg-white shadow-md mt-4">
                <div class="compass-needle-container absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center transition-transform duration-300 ease-out">
                    <div class="needle text-red-600 text-2xl">↑</div>
                    <div class="lucky-text text-yellow-600 font-bold text-base mt-1">LUCKY</div>
                </div>
            </div>

            <div id="camera" class="mx-auto w-64 h-64 border-2 border-blue-800 rounded-full overflow-hidden relative bg-black mt-4">
                <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
                <div id="overlay" class="absolute top-0 left-0 w-full h-full pointer-events-none">
                    <div class="camera-needle-container absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center transition-transform duration-300 ease-out">
                        <div class="camera-needle text-red-600 text-3xl">↑</div>
                        <div class="camera-lucky-text text-yellow-600 font-bold text-lg mt-1 text-shadow">LUCKY</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4 text-blue-800">Discover More Luck</h2>
            <p class="mb-4">Your lucky direction is just the start! Explore these tools to enhance your fortune and well-being.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-50 p-4 rounded-md">
                    <h3 class="text-lg font-medium mb-2 text-blue-800">Get Your Bazi Reading</h3>
                    <p class="text-sm text-gray-600 mb-2">Uncover your Five Elements balance and personality insights.</p>
                    <a href="https://www.yourluckycompass.com/bazi" class="inline-block bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Try Bazi Reading</a>
                </div>
                <div class="bg-gray-50 p-4 rounded-md">
                    <h3 class="text-lg font-medium mb-2 text-blue-800">Find Your Lucky City</h3>
                    <p class="text-sm text-gray-600 mb-2">Match your elements to cities that boost your luck.</p>
                    <a href="https://www.yourluckycompass.com/lucky_city" class="inline-block bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Try Lucky City Match</a>
                </div>
                <div class="bg-gray-50 p-4 rounded-md">
                    <h3 class="text-lg font-medium mb-2 text-blue-800">Relax with Sound Bath</h3>
                    <p class="text-sm text-gray-600 mb-2">Balance your energy with soothing sound meditations.</p>
                    <a href="https://www.yourluckycompass.com/sound_bath" class="inline-block bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Start Sound Bath</a>
                </div>
            </div>
        </section>

        <div id="ad-placeholder" class="ad text-center text-gray-500 my-4">
            Ad Space - Coming Soon!
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <button id="installButton" class="hidden bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 mb-4">Install App</button>
            <p>Based on ancient Chinese wisdom | For entertainment only</p>
            <p>© 2025 Your Lucky Compass</p>
        </footer>
    </div>

    <script>
        // 28星宿查询表 - 公历版
        const LUNAR_MANSIONS = [
            ["虚宿", "危宿", "室宿", "壁宿", "奎宿", "娄宿", "胃宿", "昴宿", "毕宿", "觜宿", "参宿", "井宿"],
            ["危宿", "室宿", "壁宿", "奎宿", "娄宿", "胃宿", "昴宿", "毕宿", "觜宿", "参宿", "井宿", "鬼宿"],
            ["室宿", "壁宿", "奎宿", "娄宿", "胃宿", "昴宿", "毕宿", "觜宿", "参宿", "井宿", "鬼宿", "柳宿"],
            ["壁宿", "奎宿", "娄宿", "胃宿", "昴宿", "毕宿", "觜宿", "参宿", "井宿", "鬼宿", "柳宿", "星宿"],
            ["奎宿", "娄宿", "胃宿", "昴宿", "毕宿", "觜宿", "参宿", "井宿", "鬼宿", "柳宿", "星宿", "张宿"],
            ["娄宿", "胃宿", "昴宿", "毕宿", "觜宿", "参宿", "井宿", "鬼宿", "柳宿", "星宿", "张宿", "翼宿"],
            ["胃宿", "昴宿", "毕宿", "觜宿", "参宿", "井宿", "鬼宿", "柳宿", "星宿", "张宿", "翼宿", "轸宿"],
            ["昴宿", "毕宿", "觜宿", "参宿", "井宿", "鬼宿", "柳宿", "星宿", "张宿", "翼宿", "轸宿", "角宿"],
            ["毕宿", "觜宿", "参宿", "井宿", "鬼宿", "柳宿", "星宿", "张宿", "翼宿", "轸宿", "角宿", "亢宿"],
            ["觜宿", "参宿", "井宿", "鬼宿", "柳宿", "星宿", "张宿", "翼宿", "轸宿", "角宿", "亢宿", "氐宿"],
            ["参宿", "井宿", "鬼宿", "柳宿", "星宿", "张宿", "翼宿", "轸宿", "角宿", "亢宿", "氐宿", "房宿"],
            ["井宿", "鬼宿", "柳宿", "星宿", "张宿", "翼宿", "轸宿", "角宿", "亢宿", "氐宿", "房宿", "心宿"],
            ["鬼宿", "柳宿", "星宿", "张宿", "翼宿", "轸宿", "角宿", "亢宿", "氐宿", "房宿", "心宿", "尾宿"],
            ["柳宿", "星宿", "张宿", "翼宿", "轸宿", "角宿", "亢宿", "氐宿", "房宿", "心宿", "尾宿", "箕宿"],
            ["星宿", "张宿", "翼宿", "轸宿", "角宿", "亢宿", "氐宿", "房宿", "心宿", "尾宿", "箕宿", "斗宿"],
            ["张宿", "翼宿", "轸宿", "角宿", "亢宿", "氐宿", "房宿", "心宿", "尾宿", "箕宿", "斗宿", "牛宿"],
            ["翼宿", "轸宿", "角宿", "亢宿", "氐宿", "房宿", "心宿", "尾宿", "箕宿", "斗宿", "牛宿", "女宿"],
            ["轸宿", "角宿", "亢宿", "氐宿", "房宿", "心宿", "尾宿", "箕宿", "斗宿", "牛宿", "女宿", "虚宿"],
            ["角宿", "亢宿", "氐宿", "房宿", "心宿", "尾宿", "箕宿", "斗宿", "牛宿", "女宿", "虚宿", "危宿"],
            ["亢宿", "氐宿", "房宿", "心宿", "尾宿", "箕宿", "斗宿", "牛宿", "女宿", "虚宿", "危宿", "室宿"],
            ["氐宿", "房宿", "心宿", "尾宿", "箕宿", "斗宿", "牛宿", "女宿", "虚宿", "危宿", "室宿", "壁宿"],
            ["房宿", "心宿", "尾宿", "箕宿", "斗宿", "牛宿", "女宿", "虚宿", "危宿", "室宿", "壁宿", "奎宿"],
            ["心宿", "尾宿", "箕宿", "斗宿", "牛宿", "女宿", "虚宿", "危宿", "室宿", "壁宿", "奎宿", "娄宿"],
            ["尾宿", "箕宿", "斗宿", "牛宿", "女宿", "虚宿", "危宿", "室宿", "壁宿", "奎宿", "娄宿", "胃宿"],
            ["箕宿", "斗宿", "牛宿", "女宿", "虚宿", "危宿", "室宿", "壁宿", "奎宿", "娄宿", "胃宿", "昴宿"],
            ["斗宿", "牛宿", "女宿", "虚宿", "危宿", "室宿", "壁宿", "奎宿", "娄宿", "胃宿", "昴宿", "毕宿"],
            ["牛宿", "女宿", "虚宿", "危宿", "室宿", "壁宿", "奎宿", "娄宿", "胃宿", "昴宿", "毕宿", "觜宿"],
            ["女宿", "虚宿", "危宿", "室宿", "壁宿", "奎宿", "娄宿", "胃宿", "昴宿", "毕宿", "觜宿", "参宿"],
            ["虚宿", "危宿", "室宿", "壁宿", "奎宿", "娄宿", "胃宿", "昴宿", "毕宿", "觜宿", "参宿", "井宿"],
            ["危宿", "室宿", "壁宿", "奎宿", "娄宿", "胃宿", "昴宿", "毕宿", "觜宿", "参宿", "井宿", "鬼宿"],
            ["室宿", "壁宿", "奎宿", "娄宿", "胃宿", "昴宿", "毕宿", "觜宿", "参宿", "井宿", "鬼宿", "柳宿"]
        ];

        // 星宿名称到英文翻译的映射
        const CONSTELLATION_TRANSLATIONS = {
            '角宿': 'The Horn', '亢宿': 'The Neck', '氐宿': 'The Root',
            '房宿': 'The Room', '心宿': 'The Heart', '尾宿': 'The Tail',
            '箕宿': 'The Winnowing Basket', '斗宿': 'The Dipper', '牛宿': 'The Ox',
            '女宿': 'The Girl', '虚宿': 'The Void', '危宿': 'The Rooftop',
            '室宿': 'The Encampment', '壁宿': 'The Wall', '奎宿': 'The Legs',
            '娄宿': 'The Bond', '胃宿': 'The Stomach', '昴宿': 'The Pleiades',
            '毕宿': 'The Net', '觜宿': 'The Beak', '参宿': 'The Three Stars',
            '井宿': 'The Well', '鬼宿': 'The Ghost', '柳宿': 'The Willow',
            '星宿': 'The Star', '张宿': 'The Extended Net', '翼宿': 'The Wings',
            '轸宿': 'The Chariot'
        };

        // 验证日期格式并返回规范化后的 YYYY-MM-DD 格式
        function validateDate(dateStr) {
            try {
                // 支持 YYYYMMDD 或 YYYY-MM-DD
                if (/^\d{8}$/.test(dateStr)) {
                    dateStr = `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6)}`;
                }
                if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    console.error(`Invalid date format: ${dateStr}`);
                    return null;
                }

                const [year, month, day] = dateStr.split('-').map(Number);
                // 验证日期有效性
                const date = new Date(year, month - 1, day);
                if (date.getFullYear() !== year || date.getMonth() + 1 !== month || date.getDate() !== day) {
                    throw new Error("Invalid date");
                }
                return dateStr;
            } catch (e) {
                console.error(`Invalid date: ${dateStr}, error: ${e.message}`);
                return null;
            }
        }

        // 对于无效日期，返回一个基于哈希的确定性星宿
        function getFallbackMansion(dateStr) {
            // 使用简单哈希确保一致性
            let hash = 0;
            for (let i = 0; i < dateStr.length; i++) {
                const char = dateStr.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // 转换为32位整数
            }
            const mansionIndex = Math.abs(hash) % 28;
            const mansionName = Object.keys(CONSTELLATION_TRANSLATIONS)[mansionIndex];
            console.warn(`Using fallback mansion for ${dateStr}: ${mansionName}`);
            return mansionName;
        }

        // 根据公历日期返回对应的 28 星宿名称（中文和英文）
        function getLunarMansion(dateStr) {
            // 验证日期
            const normalizedDate = validateDate(dateStr);
            if (!normalizedDate) {
                const mansion = getFallbackMansion(dateStr);
                return [mansion, CONSTELLATION_TRANSLATIONS[mansion] || mansion];
            }

            try {
                // 解析日期
                const [year, month, day] = normalizedDate.split('-').map(Number);
                // 月份从 1 开始，转换为 0-based 索引
                const monthIdx = month - 1;
                // 日期从 1 开始，转换为 0-based 索引
                const dayIdx = day - 1;

                // 检查月份和日期范围
                if (monthIdx < 0 || monthIdx > 11 || dayIdx < 0 || dayIdx > 30) {
                    console.error(`Out of range: month=${month}, day=${day}`);
                    const mansion = getFallbackMansion(dateStr);
                    return [mansion, CONSTELLATION_TRANSLATIONS[mansion] || mansion];
                }

                // 获取星宿（中文）
                const mansion = LUNAR_MANSIONS[dayIdx][monthIdx];
                // 获取英文翻译
                const translatedMansion = CONSTELLATION_TRANSLATIONS[mansion] || mansion;
                console.debug(`Date: ${dateStr}, Month: ${month}, Day: ${day}, Mansion: ${mansion}, Translated: ${translatedMansion}`);
                return [mansion, translatedMansion];

            } catch (e) {
                console.error(`Error processing date ${dateStr}: ${e.message}`);
                const mansion = getFallbackMansion(dateStr);
                return [mansion, CONSTELLATION_TRANSLATIONS[mansion] || mansion];
            }
        }

        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
            window.location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
        }

        let compassEventListener = null;
        let currentJoyAngle = 0;
        let lastAdjustedAngle = 0;
        let hasCompassError = false;
        let hasCameraError = false;
        let isInstalled = false;
        let deferredPrompt;
        let rotationHintAdded = false;

        document.getElementById('calculateBtn').addEventListener('click', calculateBazi);
        document.getElementById('permissionButton').addEventListener('click', tryGetPermissions);

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installButton').style.display = 'block';
        });

        document.getElementById('installButton').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const result = await deferredPrompt.userChoice;
                if (result.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                    isInstalled = true;
                    document.getElementById('installButton').style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        async function calculateBazi() {
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);
            const day = parseInt(document.getElementById('day').value);
            const hour = document.getElementById('hour').value ? parseInt(document.getElementById('hour').value) : null;
            const minute = document.getElementById('minute').value ? parseInt(document.getElementById('minute').value) : null;
            const timezone = document.getElementById('timezone').value;

            if (!year || !month || !day || year < 1900 || year > 2025 || month < 1 || month > 12 || day < 1 || day > 31) {
                alert("Please enter a valid birth date (Year: 1900-2025, Month: 1-12, Day: 1-31).");
                return;
            }

            if (hour !== null && (hour < 0 || hour > 23)) {
                alert("Please enter a valid hour (0-23) or leave it blank.");
                return;
            }
            if (minute !== null && (minute < 0 || minute > 59)) {
                alert("Please enter a valid minute (0-59) or leave it blank.");
                return;
            }

            try {
                const testDate = new Date(year, month - 1, day);
                if (testDate.getFullYear() !== year || testDate.getMonth() + 1 !== month || testDate.getDate() !== day) {
                    throw new Error("Invalid date.");
                }
            } catch (e) {
                alert("Invalid date. Check your input (e.g., February has 28 or 29 days).");
                return;
            }

            try {
                document.getElementById('errorContainer').innerHTML = '';
                document.getElementById('degree').textContent = '0° / --°';
                hasCompassError = false;
                hasCameraError = false;
                rotationHintAdded = false;

                document.getElementById('results').innerHTML = '<p>Calculating your cosmic destiny...</p>';
                
                let queryParams = `year=${year}&month=${month}&day=${day}&timezone=${timezone}`;
                if (hour !== null) queryParams += `&hour=${hour}`;
                if (minute !== null) queryParams += `&minute=${minute}`;
                
                console.log('Sending request with:', { year, month, day, hour, minute, timezone });
                const response = await fetch(`https://lucky-compass-backend.fly.dev/calculate?${queryParams}`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.error || `Server error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API response:', data);
                
                if (data.error) {
                    document.getElementById('results').innerHTML = `<div id="errorContainer"><p>Error: ${data.error}. Please try again or contact support.</p></div>`;
                    document.getElementById('permissionNotice').style.display = 'none';
                    return;
                }

                const baziAttributes = data.bazi || 'Unable to calculate BaZi attributes';
                
                // 计算28星宿
                const birthDateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const [lunarMansion, lunarMansionEn] = getLunarMansion(birthDateStr);
                
                document.getElementById('results').innerHTML = `
                    <div id="errorContainer"></div>
                    <p><b>Your Cosmic Calendar:</b> ${data.lunar_date || 'Unable to calculate lunar date'}</p>
                    <p><b>Your Destiny Blueprint (BaZi):</b> ${baziAttributes}</p>
                    <p><b>Your 28 Constellation:</b> ${lunarMansion} (${lunarMansionEn})</p>
                    <p><b>Your Constellation:</b> ${data.constellation || 'Unable to calculate constellation'} - ${data.constellation_description || 'No description available'}</p>
                    <p><b>Your Lucky Degree:</b> ${data.angle !== undefined ? data.angle + '°' : 'Unable to calculate lucky degree'}</p>
                    <p class="mindfulness">Face your lucky direction, take a deep breath, and let mindfulness open new doors. Small calm moments can bring big luck—try it in your lucky city from the matching feature for a fresh start!</p>
                    <p class="text-sm text-gray-600 mt-2">Pro tip: Check your Lucky Compass anytime, anywhere—your cosmic key updates with the stars, keeping your luck on point!</p>
                `;
                document.getElementById('permissionNotice').style.display = 'block';

                currentJoyAngle = data.angle || 0;
                document.getElementById('degree').textContent = `0° / ${currentJoyAngle}°`;

                if (compassEventListener) {
                    window.removeEventListener("deviceorientation", compassEventListener);
                }

                tryGetPermissions();

            } catch (error) {
                console.error('Calculation error:', error);
                document.getElementById('results').innerHTML = `<div id="errorContainer"><p>Error: ${error.message}. Please try again or contact support.</p></div>`;
            }
        }

        async function tryGetPermissions() {
            try {
                const compassGranted = await requestCompassPermission();
                if (compassGranted) {
                    await startCamera();
                }
            } catch (error) {
                console.log("Permission request failed:", error);
            }
        }

        async function requestCompassPermission() {
            if (!("DeviceOrientationEvent" in window)) {
                if (!hasCompassError) {
                    document.getElementById('errorContainer').innerHTML += `<p>Compass not supported on this device. Use a phone with a compass sensor.</p>`;
                    hasCompassError = true;
                }
                return false;
            }

            try {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permissionState = await DeviceOrientationEvent.requestPermission();
                    if (permissionState !== 'granted') {
                        if (!hasCompassError) {
                            document.getElementById('errorContainer').innerHTML += `<p class="permission-prompt">Compass permission denied. Go to Settings → Safari → Privacy & Security → Enable "Motion & Orientation Access" for this site.</p>`;
                            hasCompassError = true;
                        }
                        return false;
                    }
                }

                compassEventListener = function updateCompass(event) {
                    const alpha = event.alpha || 0;
                    let adjustedAngle = (360 - alpha + currentJoyAngle) % 360;
                    
                    const angleDiff = adjustedAngle - lastAdjustedAngle;
                    if (angleDiff > 180) {
                        adjustedAngle -= 360;
                    } else if (angleDiff < -180) {
                        adjustedAngle += 360;
                    }
                    
                    lastAdjustedAngle = adjustedAngle;
                    document.querySelector('.compass-needle-container').style.transform = 
                        `translate(-50%, -50%) rotate(${adjustedAngle}deg)`;
                    document.querySelector('.camera-needle-container').style.transform = 
                        `translate(-50%, -50%) rotate(${adjustedAngle}deg)`;
                    document.getElementById('degree').textContent = `${Math.round(alpha)}° / ${currentJoyAngle}°`;
                };
                window.addEventListener("deviceorientation", compassEventListener);

                if (!hasCompassError && !rotationHintAdded) {
                    document.getElementById('errorContainer').innerHTML += `<p>Rotate your phone to align with the LUCKY marker!</p>`;
                    rotationHintAdded = true;
                }
                return true;

            } catch (error) {
                if (!hasCompassError) {
                    document.getElementById('errorContainer').innerHTML += `<p class="permission-prompt">Please tap "Allow" when the browser asks for orientation access.</p>`;
                    console.error('Compass Permission Error:', error);
                    hasCompassError = true;
                }
                return false;
            }
        }

        async function startCamera() {
            if (!("mediaDevices" in navigator) || !("getUserMedia" in navigator.mediaDevices)) {
                if (!hasCameraError) {
                    document.getElementById('errorContainer').innerHTML += `<p>Camera access is not supported on this device.</p>`;
                    hasCameraError = true;
                }
                return false;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 300 },
                        height: { ideal: 300 }
                    } 
                });
                
                const videoElement = document.getElementById('video');
                videoElement.srcObject = stream;
                
                hasCameraError = false;
                return true;
                
            } catch (error) {
                console.error('Camera error:', error);
                
                if (!hasCameraError) {
                    let errorMessage = '<p class="permission-prompt">Camera access is required. Please allow camera permissions.</p>';
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage = '<p class="permission-prompt">Camera permission denied. Please enable camera access in your browser settings.</p>';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage = '<p>No camera found on this device.</p>';
                    } else if (error.name === 'NotReadableError') {
                        errorMessage = '<p>Camera is in use by another application.</p>';
                    }
                    
                    document.getElementById('errorContainer').innerHTML += errorMessage;
                    hasCameraError = true;
                }
                return false;
            }
        }

        window.addEventListener('beforeunload', () => {
            if (compassEventListener) {
                window.removeEventListener("deviceorientation", compassEventListener);
            }
            
            const videoElement = document.getElementById('video');
            if (videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => track.stop());
            }
        });

        async function shareSite() {
            try {
                await navigator.share({
                    title: 'My Lucky Direction - Your Lucky Compass',
                    text: 'Check out my lucky direction!',
                    url: window.location.href
                });
            } catch (err) {
                alert('Share failed: ' + err);
            }
        }
    </script>
</body>
</html>
