<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Lucky Compass</title>
    <!-- 内联 Tailwind CSS 以避免 CSP 问题 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E40AF',
                        secondary: '#3B82F6',
                        accent: '#F59E0B',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .compass-needle {
                transform-origin: center;
                transition: transform 0.1s ease-out;
            }
            .compass-dial {
                transform-origin: center;
            }
            .shadow-compass {
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
        }
    </style>
    <!-- 内联 Font Awesome 核心样式以避免 CSP 问题 -->
    <style>
        .fa {
            display: inline-block;
            font: normal normal normal 14px/1 FontAwesome;
            font-size: inherit;
            text-rendering: auto;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .fa-compass:before { content: "\f14e"; }
        .fa-sun-o:before { content: "\f185"; }
        .fa-moon-o:before { content: "\f186"; }
        .fa-birthday-cake:before { content: "\f1fd"; }
        .fa-arrow-up:before { content: "\f062"; }
        .fa-arrow-right:before { content: "\f061"; }
        .fa-arrow-down:before { content: "\f063"; }
        .fa-arrow-left:before { content: "\f060"; }
    </style>
    <style>
        /* 基础样式 */
        body {
            background-color: #f0f9ff;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(245, 158, 11, 0.05) 0%, transparent 20%);
            min-height: 100vh;
        }
        
        /* 指南针样式 */
        .compass-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto;
        }
        
        .compass-dial {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .compass-marker {
            position: absolute;
            width: 100%;
            height: 100%;
            text-align: center;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .compass-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #F59E0B;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.6);
            z-index: 10;
        }
        
        .compass-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120px;
            height: 8px;
            margin-top: -4px;
            margin-left: -60px;
            background: linear-gradient(90deg, transparent 45%, #F59E0B 45%, #F59E0B 55%, transparent 55%);
            z-index: 5;
        }
        
        .lucky-indicator {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #F59E0B;
            color: white;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        /* 度数标记 */
        .degree-mark {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: center;
        }
        
        .degree-mark::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.7);
        }
        
        .degree-mark.major::before {
            width: 3px;
            height: 12px;
            background-color: white;
        }
        
        /* 加载动画 */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        /* 响应式调整 */
        @media (min-width: 640px) {
            .compass-container {
                width: 360px;
                height: 360px;
            }
            
            .compass-needle {
                width: 160px;
                margin-left: -80px;
            }
        }
    </style>
</head>
<body class="font-sans text-dark">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <header class="text-center mb-8">
            <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold text-primary mb-2 text-shadow">Your Lucky Compass</h1>
            <p class="text-gray-600">Discover your personal lucky direction based on your birth date</p>
        </header>

        <!-- 出生日期表单 -->
        <div class="bg-white rounded-xl p-6 shadow-lg mb-8 transform transition-all hover:shadow-xl">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-birthday-cake text-accent mr-2"></i>
                Enter Your Birth Date
            </h2>
            <form id="birthDateForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="birthYear" class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                        <select id="birthYear" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                            <!-- 年份选项将通过JavaScript生成 -->
                        </select>
                    </div>
                    <div>
                        <label for="birthMonth" class="block text-sm font-medium text-gray-700 mb-1">Month</label>
                        <select id="birthMonth" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div>
                        <label for="birthDay" class="block text-sm font-medium text-gray-700 mb-1">Day</label>
                        <select id="birthDay" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                            <!-- 日期选项将通过JavaScript生成 -->
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="degreeSelect" class="block text-sm font-medium text-gray-700 mb-1">Degree System</label>
                    <select id="degreeSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                        <option value="8">8 Directions (45° increments)</option>
                        <option value="16">16 Directions (22.5° increments)</option>
                        <option value="32">32 Directions (11.25° increments)</option>
                        <option value="360">360 Degrees (1° increments)</option>
                    </select>
                </div>
                
                <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary/50">
                    Calculate Lucky Direction
                </button>
            </form>
        </div>

        <!-- 指南针显示区域 -->
        <div id="compassContainer" class="hidden mb-8">
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <h2 class="text-xl font-semibold mb-6 text-center">Lucky Direction Compass</h2>
                
                <!-- 幸运方向信息 -->
                <div id="luckyDirectionInfo" class="text-center mb-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                    <p class="text-lg font-medium text-primary" id="luckyDirectionText">Your Lucky Direction: Calculating...</p>
                </div>
                
                <!-- 指南针组件 -->
                <div class="compass-container">
                    <!-- 指南针刻度盘 -->
                    <div class="compass-dial">
                        <!-- 方向标记 -->
                        <div class="compass-marker" style="top: 15px; left: 50%; transform: translateX(-50%);">N</div>
                        <div class="compass-marker" style="top: 50%; right: 15px; transform: translateY(-50%);">E</div>
                        <div class="compass-marker" style="bottom: 15px; left: 50%; transform: translateX(-50%);">S</div>
                        <div class="compass-marker" style="top: 50%; left: 15px; transform: translateY(-50%);">W</div>
                        
                        <!-- 度数标记将通过JavaScript生成 -->
                    </div>
                    
                    <!-- 幸运方向指示器 -->
                    <div id="luckyMarker" class="compass-marker lucky-indicator">LUCKY</div>
                    
                    <!-- 指南针指针 -->
                    <div class="compass-needle" id="compassNeedle"></div>
                    
                    <!-- 中心点 -->
                    <div class="compass-center"></div>
                </div>
                
                <!-- 方向状态 -->
                <div class="mt-6 text-center">
                    <p class="text-gray-700" id="directionStatus">Current Direction / Lucky Direction</p>
                    <p class="text-lg font-semibold mt-1" id="degreeDisplay">0° / Calculating...</p>
                </div>
            </div>
        </div>

        <!-- 结果和提示 -->
        <div id="resultContainer" class="hidden bg-white rounded-xl p-6 shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4">Guidance</h2>
            <div id="guidanceText" class="text-gray-700 space-y-3">
                <!-- 指导文本将通过JavaScript生成 -->
            </div>
            
            <div id="errorContainer" class="mt-4 hidden p-3 bg-red-50 text-red-600 rounded-lg border border-red-100">
                <p id="errorText"></p>
            </div>
        </div>

        <footer class="text-center text-gray-500 text-sm mt-12">
            <p>For best results, hold your device flat and away from magnetic interference.</p>
            <p class="mt-2">Your Lucky Compass © 2023</p>
        </footer>
    </div>

    <script>
        // DOM元素
        const birthDateForm = document.getElementById('birthDateForm');
        const birthYear = document.getElementById('birthYear');
        const birthMonth = document.getElementById('birthMonth');
        const birthDay = document.getElementById('birthDay');
        const degreeSelect = document.getElementById('degreeSelect');
        const compassContainer = document.getElementById('compassContainer');
        const resultContainer = document.getElementById('resultContainer');
        const luckyDirectionText = document.getElementById('luckyDirectionText');
        const directionStatus = document.getElementById('directionStatus');
        const degreeDisplay = document.getElementById('degreeDisplay');
        const guidanceText = document.getElementById('guidanceText');
        const compassNeedle = document.getElementById('compassNeedle');
        const luckyMarker = document.getElementById('luckyMarker');
        const errorContainer = document.getElementById('errorContainer');
        const errorText = document.getElementById('errorText');
        const compassDial = document.querySelector('.compass-dial');
        
        // 生成年份选项 (1950-2023)
        const currentYear = new Date().getFullYear();
        for (let year = currentYear; year >= 1950; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            birthYear.appendChild(option);
        }
        
        // 生成日期选项 (1-31)
        for (let day = 1; day <= 31; day++) {
            const option = document.createElement('option');
            option.value = day;
            option.textContent = day;
            birthDay.appendChild(option);
        }
        
        // 方向和元素对应关系
        const directions = [
            { degree: 0, name: 'North', element: 'Water' },
            { degree: 45, name: 'Northeast', element: 'Earth' },
            { degree: 90, name: 'East', element: 'Wood' },
            { degree: 135, name: 'Southeast', element: 'Wood' },
            { degree: 180, name: 'South', element: 'Fire' },
            { degree: 225, name: 'Southwest', element: 'Earth' },
            { degree: 270, name: 'West', element: 'Metal' },
            { degree: 315, name: 'Northwest', element: 'Metal' }
        ];
        
        // 更详细的方向划分
        const detailedDirections = {
            16: [
                0, 22.5, 45, 67.5, 90, 112.5, 135, 157.5,
                180, 202.5, 225, 247.5, 270, 292.5, 315, 337.5
            ],
            32: [
                0, 11.25, 22.5, 33.75, 45, 56.25, 67.5, 78.75,
                90, 101.25, 112.5, 123.75, 135, 146.25, 157.5, 168.75,
                180, 191.25, 202.5, 213.75, 225, 236.25, 247.5, 258.75,
                270, 281.25, 292.5, 303.75, 315, 326.25, 337.5, 348.75
            ]
        };
        
        // 生成指南针度数标记
        function generateDegreeMarks(divisions = 8) {
            // 清除现有标记
            document.querySelectorAll('.degree-mark').forEach(mark => mark.remove());
            
            let degrees;
            if (divisions === 360) {
                degrees = Array.from({length: 360}, (_, i) => i);
            } else if (divisions === 16 || divisions === 32) {
                degrees = detailedDirections[divisions];
            } else {
                // 默认8个方向
                degrees = directions.map(dir => dir.degree);
            }
            
            degrees.forEach(degree => {
                const mark = document.createElement('div');
                mark.className = `degree-mark ${degree % 90 === 0 ? 'major' : ''}`;
                mark.style.transform = `rotate(${degree}deg)`;
                compassDial.appendChild(mark);
            });
        }
        
        // 初始化指南针标记
        generateDegreeMarks();
        
        // 根据出生日期计算幸运方向
        function calculateLuckyDirection(year, month, day) {
            // 简单的计算算法，基于出生日期的数字之和
            const sum = year + month + day;
            // 计算0-359之间的度数
            const baseDegree = sum % 360;
            
            // 根据选择的度数系统调整
            const divisions = parseInt(degreeSelect.value);
            let luckyDegree;
            
            if (divisions === 360) {
                luckyDegree = baseDegree;
            } else if (divisions === 16 || divisions === 32) {
                // 找到最接近的详细方向
                const possibleDegrees = detailedDirections[divisions];
                luckyDegree = possibleDegrees.reduce((prev, curr) => {
                    return (Math.abs(curr - baseDegree) < Math.abs(prev - baseDegree) ? curr : prev);
                });
            } else {
                // 8个方向，每45度一个
                luckyDegree = Math.round(baseDegree / 45) * 45;
                // 确保在0-359范围内
                if (luckyDegree >= 360) luckyDegree = 0;
            }
            
            return luckyDegree;
        }
        
        // 获取方向名称和元素
        function getDirectionInfo(degree) {
            // 对于详细度数，找到最接近的主方向
            let closest = directions[0];
            let minDiff = Math.abs(degree - closest.degree);
            
            directions.forEach(dir => {
                const diff = Math.abs(degree - dir.degree);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = dir;
                }
            });
            
            return closest;
        }
        
        // 更新指南针显示
        function updateCompass(currentDegree, luckyDegree) {
            // 旋转指针指向当前方向
            compassNeedle.style.transform = `rotate(${currentDegree}deg)`;
            
            // 设置幸运方向标记
            luckyMarker.style.transform = `rotate(${luckyDegree}deg) translateX(-50%)`;
            
            // 更新显示的度数
            const currentDeg = Math.round(currentDegree) % 360;
            const luckyDeg = Math.round(luckyDegree) % 360;
            degreeDisplay.textContent = `${currentDeg}° / ${luckyDeg}°`;
            
            // 检查是否对准幸运方向
            const tolerance = 5; // 允许的误差范围（度）
            const diff = Math.abs(currentDeg - luckyDeg);
            const isAligned = diff <= tolerance || diff >= 360 - tolerance;
            
            if (isAligned) {
                directionStatus.textContent = "You're aligned with your lucky direction!";
                directionStatus.className = "text-green-600 font-medium";
            } else {
                directionStatus.textContent = "Current Direction / Lucky Direction";
                directionStatus.className = "text-gray-700";
            }
        }
        
        // 更新指导文本
        function updateGuidance(luckyDegree) {
            const dirInfo = getDirectionInfo(luckyDegree);
            let guidance = `
                <p>Your lucky direction is ${luckyDegree}° (${dirInfo.name} - ${dirInfo.element} element).</p>
                <p>Rotate your phone to align with the LUCKY marker!</p>
            `;
            
            // 根据不同方向添加特定建议
            switch(dirInfo.name) {
                case 'North':
                    guidance += `<p>This direction is associated with wisdom and career growth. Position your desk facing north for better focus.</p>`;
                    break;
                case 'East':
                    guidance += `<p>This direction symbolizes new beginnings and family harmony. Place your bedroom in the east for peaceful sleep.</p>`;
                    break;
                case 'South':
                    guidance += `<p>This direction represents fame and recognition. A south-facing living room can enhance social connections.</p>`;
                    break;
                case 'West':
                    guidance += `<p>This direction is linked to creativity and children. A west-facing study can boost creative thinking.</p>`;
                    break;
                default:
                    guidance += `<p>This intermediate direction combines the energies of its neighboring cardinal directions.</p>`;
            }
            
            guidanceText.innerHTML = guidance;
        }
        
        // 处理设备方向
        let luckyDegree = 0;
        let currentDegree = 0;
        let isWatching = false;
        
        function handleOrientation(event) {
            // 使用alpha值（设备绕z轴的旋转）作为方向
            if (event.alpha !== null) {
                currentDegree = 360 - event.alpha; // 反转以匹配指南针方向
                updateCompass(currentDegree, luckyDegree);
            }
        }
        
        // 尝试启动摄像头（用于AR效果）
        function startCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        // 摄像头启动成功，但在这个简化版本中我们不显示视频流
                        // 实际应用中可以将视频流显示在指南针下方作为AR背景
                        showError(''); // 清除任何摄像头错误
                    })
                    .catch(function(error) {
                        console.error('Camera error:', error);
                        showError(`Camera access required for AR view: ${error.message}`);
                    });
            } else {
                showError('Camera not supported on this device');
            }
        }
        
        // 显示错误信息
        function showError(message) {
            if (message) {
                errorText.textContent = message;
                errorContainer.classList.remove('hidden');
            } else {
                errorContainer.classList.add('hidden');
            }
        }
        
        // 表单提交处理
        birthDateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const year = parseInt(birthYear.value);
            const month = parseInt(birthMonth.value);
            const day = parseInt(birthDay.value);
            
            // 简单的日期验证
            const date = new Date(year, month - 1, day);
            if (date.getFullYear() !== year || date.getMonth() + 1 !== month || date.getDate() !== day) {
                alert('Please enter a valid date');
                return;
            }
            
            // 计算幸运方向
            luckyDegree = calculateLuckyDirection(year, month, day);
            const dirInfo = getDirectionInfo(luckyDegree);
            
            // 更新显示
            luckyDirectionText.textContent = `Your Lucky Direction: ${luckyDegree}° (${dirInfo.name} (${dirInfo.element}))`;
            
            // 生成对应度数的标记
            generateDegreeMarks(parseInt(degreeSelect.value));
            
            // 更新指导文本
            updateGuidance(luckyDegree);
            
            // 显示指南针和结果
            compassContainer.classList.remove('hidden');
            resultContainer.classList.remove('hidden');
            
            // 启动摄像头
            startCamera();
            
            // 开始监听设备方向
            if (!isWatching) {
                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', handleOrientation);
                    isWatching = true;
                } else {
                    showError('Device orientation is not supported on this device');
                    // 使用默认值更新指南针
                    updateCompass(0, luckyDegree);
                }
            } else {
                // 已经在监听，只需更新幸运方向
                updateCompass(currentDegree, luckyDegree);
            }
        });
        
        // 度数系统变更时重新生成标记
        degreeSelect.addEventListener('change', function() {
            if (compassContainer.classList.contains('hidden')) return;
            
            const divisions = parseInt(this.value);
            generateDegreeMarks(divisions);
            
            // 重新计算幸运方向
            const year = parseInt(birthYear.value);
            const month = parseInt(birthMonth.value);
            const day = parseInt(birthDay.value);
            luckyDegree = calculateLuckyDirection(year, month, day);
            
            const dirInfo = getDirectionInfo(luckyDegree);
            luckyDirectionText.textContent = `Your Lucky Direction: ${luckyDegree}° (${dirInfo.name} (${dirInfo.element}))`;
            
            updateGuidance(luckyDegree);
            updateCompass(currentDegree, luckyDegree);
        });
        
        // 页面卸载时停止监听
        window.addEventListener('beforeunload', function() {
            if (isWatching) {
                window.removeEventListener('deviceorientation', handleOrientation);
            }
        });
    </script>
</body>
</html>
